# Statistical Analysis

```{r, include = FALSE}
pacman::p_load(magrittr, readxl, DT, summarytools)
```

## Setup

In this section, we'll provide some examples of basic statistical analyses you might be called upon to do at some point.

Note that the analyses you conduct as part of real research will almost certainly be more complicated than the code shown here. However, the hope is that you'll get enough of a feel to begin putting the pieces together as demanded by a given project.

### Data

If you'd like to try any of these examples on your own, we're using the NHEFS data set freely available at the [website](https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/) for _Causal Inference: What If_ by Miguel A. HernÃ¡n and James M. Robins.

For examples based in R, we'll use the CSV file they provide, and the sas7bdat data set for our SAS examples.

The website itself contains extensive code examples in SAS, Stata, R, and Python---everything you could want!---so those who will be taking advanced epidemiologic or causal inference coursework should refer to those resources for guidance on how to implement relevant analyses. We'll cover a little bit here, but only briefly.

### NHEFS Codebook

```{r nhefs-codebook, echo = FALSE}
readxl::read_excel("data/NHEFS_Codebook.xls") %>%
  knitr::kable()
```

## Exploratory Data Analysis

First, let's read in our data and glance at it using a couple of different views.

```{r read-nhefs, message = F}
nhefs <- readr::read_csv("data/nhefs.csv")
head(nhefs)
tibble::glimpse(nhefs)
```

For now, let's focus on observations (rows) that don't have any missing data. To do this, let's get a summary of how much missingness we have across the `r format(nrow(nhefs), big.mark = ",")` observations.

```{r count-missing}
allvars <- names(nhefs)

df_miss <- data.frame(variable = allvars)

df_miss <- df_miss %>%
  dplyr::rowwise() %>%
  dplyr::mutate(n_miss = sum(is.na(nhefs[[variable]])))

print(df_miss, n = nrow(df_miss))
```

That looks a little hairy. Basically, all we did here was to create data.frame, save the NHEFS variable names to its first column, then look up each variable in the NHEFS data set and count the number of missing values.

However, we could have gotten this summary in a number of different ways.

```{r alt-missing-counts}
lapply(nhefs, function(x) table(is.na(x)))
sapply(nhefs, function(x) sum(is.na(x)))
```

Let's drop every row with a missing value for any variable

```{r omit-too-many}
nhefs2 <- na.omit(nhefs)
tibble::glimpse(nhefs2)
```

Oops, we have only `r nrow(nhefs2)` rows left in the data set! Perhaps we should reconsider, and pick several variables that will be of interest to us for our current purposes.

```{r subset-variables}
selectvars <- c(
  "age", "alcoholfreq", "asthma", "wt71",
  "smokeintensity", "sbp", "allergies"
)

nhefs3 <- na.omit(nhefs[, selectvars])
tibble::glimpse(nhefs3)
```

That's better. We've discarded `r nrow(nhefs) - nrow(nhefs3)` rows and focused on a subset of variables of interest.

Look back at the output we got from `glimpse()`. Are the variables in the formats we expect/need? I see one that we may need to update, depending on how we plan to use it. (Hint: Look back at the codebook for the variable summaries)

It seems that `alcoholfreq` is current being treated as a numeric variables, but really, it's a factor with 5 discrete levels. Furthermore, level 5 is Unknown, which we should probably treat as missing. We'll also use a factor format for `alcoholfreq`.

<span class="marginnote">We could leave `alcoholfreq` as a numeric variable and wrap it in the `factor()` function only when we needed to. In some cases, that approach might be preferable, in some cases not.</span>

```{r factor-check}
nhefs3$alcfreq <- as.factor(nhefs3$alcoholfreq)
table(nhefs3$alcfreq)
```

Let's replace those 5 missing values with NA's, too, and drop the corresponding rows from our data set. Let's also get rid of the original `alcoholfreq` variable and just hang on to the factor variable we made.

```{r, alcfreq}
# In words: where alcfreq in nhefs3 equals 5, assign NA
nhefs3$alcfreq[nhefs3$alcfreq == 5] <- NA

nhefs4 <- na.omit(nhefs3)
nhefs4$alcoholfreq <- NULL

tibble::glimpse(nhefs4)
```

Let's summarize our dataset:

```{r eda-stats}
# Continuous variables
contvars <- c("age", "wt71", "smokeintensity", "sbp")
summary(nhefs4[, contvars])

# Categorical variables
catvars <- c("asthma", "allergies", "alcfreq")
lapply(
  X = catvars,
  FUN = function(x) {
    summarytools::freq(nhefs4[x])
  })
```

<span class="marginnote">Based on this [tidy example](https://www.r-bloggers.com/quick-plot-of-all-variables/).</span>

A few plots may help us, too:

```{r eda-density, warning = FALSE, dev = "svg"}
library(ggplot2)
library(ggthemes)

nhefs4 %>%
  dplyr::select(all_of(contvars)) %>%
  tidyr::gather() %>%
  ggplot(aes(x = value)) +
  facet_wrap(~key, scales = "free") +
  geom_density() +
  theme_tufte(base_size = 16)
```

```{r eda-bars, warning = FALSE, dev = "svg"}
nhefs4 %>%
  dplyr::select(all_of(catvars)) %>%
  tidyr::gather() %>%
  ggplot(aes(x = value)) +
  facet_wrap(~key, nrow = 2, scales = "free") +
  geom_bar(stat = "count", width = 0.5, fill = "lightgray") +
  theme_tufte(base_size = 16)
```

Don't worry just now about the plot code. We'll be looking in some detail at the ggplot2 package later.

## Tabular Analysis



## Regression Models
